{% extends "base.html" %}
{% block title %}Clone User Â· Onboard &amp; Offboard{% endblock %}
{% block content %}
  <h1>Clone an Existing User</h1>
  <form method="get" class="field" action="{{ url_for('clone_user') }}">
    <label for="query">Search Directory</label>
    <div style="display:flex; gap:0.5rem;">
      <input id="query" name="query" type="text" value="{{ query }}" placeholder="Search by name, username, or email" />
      <button type="submit">Search</button>
    </div>
  </form>

  {% if search_results %}
    <h2>Results</h2>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Username</th>
          <th>Email</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for user in search_results %}
          <tr>
            <td>{{ user.get('displayName') }}</td>
            <td>{{ user.get('sAMAccountName') }}</td>
            <td>{{ user.get('mail') }}</td>
            <td><a class="button secondary" href="{{ url_for('clone_user', user_dn=user.get('distinguishedName')) }}">Use as template</a></td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% elif query %}
    <p>No users matched "{{ query }}".</p>
  {% endif %}

  {% if selected_user %}
    <h2 style="margin-top: 2rem;">Clone Details</h2>
    <form method="post">
      <input type="hidden" name="source_dn" value="{{ selected_user.get('distinguishedName') }}" />
      <div class="field">
        <label for="first_name">New First Name</label>
        <input id="first_name" name="first_name" type="text" value="{{ request.form.first_name or '' }}" required />
      </div>
      <div class="field">
        <label for="last_name">New Last Name</label>
        <input id="last_name" name="last_name" type="text" value="{{ request.form.last_name or '' }}" required />
      </div>
      <div class="field">
        <label for="username">New Username (sAMAccountName)</label>
        <input
          id="username"
          name="username"
          type="text"
          value="{{ request.form.username or generated_username or '' }}"
          data-manual="{{ '1' if request.form.username else '0' }}"
          required
          autocomplete="off"
        />
      </div>
      <div class="field">
        <label for="email">New Email</label>
        <input
          id="email"
          name="email"
          type="email"
          value="{{ request.form.email or generated_email or '' }}"
          required
          {% if email_domain %}readonly{% endif %}
        />
      </div>
      <div class="field">
        <label for="telephone_number">Telephone Number (optional)</label>
        <input
          id="telephone_number"
          name="telephone_number"
          type="tel"
          value="{{ request.form.telephone_number or '' }}"
          placeholder="+16125551234"
          autocomplete="off"
        />
      </div>
      <div class="field">
        <label for="mobile_number">Mobile Number (optional)</label>
        <input
          id="mobile_number"
          name="mobile_number"
          type="tel"
          value="{{ request.form.mobile_number or '' }}"
          placeholder="+16125551234"
          autocomplete="off"
        />
      </div>
      <div class="field">
        <label for="job_role">Target Job Role</label>
        <input
          id="job_role"
          name="job_role"
          type="text"
          list="clone-job-role-suggestions"
          value="{{ request.form.job_role or prefilled_job_role or '' }}"
          placeholder="Start typing a job title"
          required
          autocomplete="off"
        />
        <datalist id="clone-job-role-suggestions">
          {% for name in job_titles %}
            <option value="{{ name }}"></option>
          {% endfor %}
        </datalist>
        <div class="hint">Pick an existing role or enter a new job title.</div>
      </div>
      <div class="field">
        <label for="group_search">Groups</label>
        <div id="group_tags" class="tag-list"></div>
        <div class="autocomplete">
          <input
            id="group_search"
            type="text"
            placeholder="Search for groups"
            autocomplete="off"
          />
          <div class="autocomplete-results" id="group_results" hidden></div>
        </div>
        <button type="button" class="inline-button" id="apply_role_groups">Apply role groups</button>
        <div class="hint">
          Groups from the template user and selected role are listed here. Search to add more or remove tags to exclude.
        </div>
        <div id="group_hidden_inputs">
          {% for group in selected_groups %}
            <input type="hidden" name="groups" value="{{ group }}" />
          {% endfor %}
        </div>
      </div>
      {% if m365_status.configured %}
        <div class="field" id="license_field">
          <label>Microsoft 365 Licenses</label>
          <div id="license_catalog" class="license-catalog"></div>
          <div class="hint">
            Choose one or more licenses to assign to the cloned user. Toggle individual apps under each license to fine-tune access.
          </div>
          <div class="field-actions">
            {% if template_license_selection %}
              <button type="button" class="inline-button" id="apply_template_license">Use template license</button>
            {% endif %}
            <button type="button" class="inline-button" id="apply_role_license">Use role defaults</button>
            <button type="button" class="inline-button" id="clear_license">Clear all</button>
          </div>
          <small id="license_status_message" class="hint"></small>
          <div id="license_hidden_inputs"></div>
          {% if template_license_selection and template_license_selection.assigned_count|int > 1 %}
            <small class="hint">
              Template user has multiple licenses; use "Use template license" to mirror their current assignments.
            </small>
          {% endif %}
        </div>
      {% else %}
        <div class="status-card">
          <span class="badge">Not Configured</span>
          <p>
            Microsoft 365 credentials have not been configured. Add them on the Configuration page to manage licenses during cloning.
          </p>
        </div>
      {% endif %}
      <div class="field">
        <label for="password">Temporary Password</label>
        <input id="password" name="password" type="password" required />
      </div>
      <div class="field">
        <label for="manager_dn">Manager</label>
        <div class="autocomplete">
          <input
            id="manager_search"
            name="manager_search"
            type="text"
            value="{{ request.form.manager_search or default_manager_label or '' }}"
            placeholder="Search by name, username, or email"
            autocomplete="off"
          />
          <input
            id="manager_dn"
            name="manager_dn"
            type="hidden"
            value="{{ request.form.manager_dn or default_manager or '' }}"
          />
          <div class="autocomplete-results" id="manager_results" hidden></div>
        </div>
        <button type="button" class="inline-button" id="manager_use_default">Use job role default</button>
        <div class="hint">Leave blank to apply the job role&rsquo;s default manager.</div>
      </div>
      <div class="field">
        <label for="company">Company</label>
        <input
          id="company"
          name="company"
          type="text"
          list="clone-company-suggestions"
          value="{{ request.form.company or selected_user.get('company') or '' }}"
          placeholder="Select or type a company"
          autocomplete="off"
        />
        <datalist id="clone-company-suggestions">
          {% for company in companies %}
            <option value="{{ company }}"></option>
          {% endfor %}
        </datalist>
      </div>
      <div class="field">
        <label for="office">Office (optional)</label>
        <input
          id="office"
          name="office"
          type="text"
          list="clone-office-suggestions"
          value="{{ request.form.office or selected_user.get('physicalDeliveryOfficeName') or '' }}"
          placeholder="Select or type an office"
          autocomplete="off"
        />
        <datalist id="clone-office-suggestions">
          {% for office in offices %}
            <option value="{{ office }}"></option>
          {% endfor %}
        </datalist>
      </div>
      <div class="field">
        <label for="user_ou">Organizational Unit</label>
        <input
          id="user_ou"
          name="user_ou"
          type="text"
          list="clone-ou-suggestions"
          value="{{ request.form.user_ou or default_ou or '' }}"
          placeholder="Leave blank to use the job role default"
          autocomplete="off"
        />
        <datalist id="clone-ou-suggestions">
          {% for ou in ous %}
            <option value="{{ ou }}"></option>
          {% endfor %}
        </datalist>
      </div>
      <div class="field">
        <label for="attributes">Attributes (key=value per line)</label>
        <textarea id="attributes" name="attributes">{{ request.form.attributes or default_attributes }}</textarea>
      </div>
      <div class="field">
        <button type="submit">Clone Account &amp; Sync</button>
      </div>
    </form>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const fetchJson = async (endpoint, query, limit = 20) => {
          const url = new URL(endpoint, window.location.origin);
          if (query) {
            url.searchParams.set("q", query);
          }
          if (limit) {
            url.searchParams.set("limit", limit);
          }
          const response = await fetch(url.toString(), {
            headers: { Accept: "application/json" },
          });
          if (!response.ok) {
            throw new Error(`Directory lookup failed (${response.status})`);
          }
          return response.json();
        };

        const wireDatalist = (inputId, datalistId, endpoint, initial = [], options = {}) => {
          const input = document.getElementById(inputId);
          const datalist = document.getElementById(datalistId);
          if (!input || !datalist) {
            return { setStatic: () => {} };
          }
          const minLength =
            typeof options.minLength === "number" && options.minLength >= 0
              ? options.minLength
              : 2;
          const preload = Boolean(options.preload);
          const requestLimit =
            typeof options.limit === "number" && options.limit > 0 ? options.limit : 200;
          let staticItems = Array.from(
            new Set((initial || []).map((item) => (item || "").trim()).filter(Boolean))
          );

          const render = (dynamicItems = []) => {
            const seen = new Set();
            datalist.innerHTML = "";
            const addOption = (value) => {
              const normalized = (value || "").trim();
              if (!normalized || seen.has(normalized)) {
                return;
              }
              const option = document.createElement("option");
              option.value = normalized;
              datalist.appendChild(option);
              seen.add(normalized);
            };
            staticItems.forEach(addOption);
            (dynamicItems || []).forEach(addOption);
          };
          render();

          const fetchAndRender = async (query) => {
            try {
              const payload = await fetchJson(endpoint, query, requestLimit);
              render(payload.items || []);
            } catch (error) {
              console.error(error);
            }
          };

          let timer;
          input.addEventListener("input", () => {
            clearTimeout(timer);
            const value = input.value.trim();
            if (value.length < minLength) {
              render();
              return;
            }
            timer = setTimeout(async () => {
              fetchAndRender(value);
            }, 200);
          });

          if (preload) {
            input.addEventListener("focus", () => {
              fetchAndRender(input.value.trim());
            });
            fetchAndRender("");
          }

          return {
            setStatic(items) {
              staticItems = Array.from(
                new Set((items || []).map((item) => (item || "").trim()).filter(Boolean))
              );
              render();
            },
          };
        };

        const wireManagerAutocomplete = () => {
          const input = document.getElementById("manager_search");
          const hidden = document.getElementById("manager_dn");
          const results = document.getElementById("manager_results");
          const useDefaultBtn = document.getElementById("manager_use_default");
          if (!input || !hidden || !results || !useDefaultBtn) {
            return;
          }
          const clearResults = () => {
            results.innerHTML = "";
            results.hidden = true;
          };
          let timer;
          input.addEventListener("input", () => {
            if (!input.dataset.manual) {
              hidden.value = "";
            }
            input.dataset.manual = "1";
            clearTimeout(timer);
            const value = input.value.trim();
            if (value.length < 2) {
              clearResults();
              return;
            }
            timer = setTimeout(async () => {
              try {
                const payload = await fetchJson("/api/managers", value);
                results.innerHTML = "";
                (payload.items || []).forEach((item) => {
                  if (!item || !item.distinguishedName) {
                    return;
                  }
                  const div = document.createElement("div");
                  div.className = "autocomplete-item";
                  const segments = [];
                  if (item.displayName) {
                    segments.push(item.displayName);
                  }
                  if (item.title) {
                    segments.push(`(${item.title})`);
                  }
                  if (item.mail) {
                    segments.push(item.mail);
                  }
                  if (item.sAMAccountName) {
                    segments.push(item.sAMAccountName);
                  }
                  if (item.userPrincipalName && item.userPrincipalName !== item.mail) {
                    segments.push(item.userPrincipalName);
                  }
                  const label = segments.join(" ").trim();
                  div.textContent = label || item.distinguishedName;
                  div.dataset.dn = item.distinguishedName;
                  div.dataset.display = label;
                  div.addEventListener("mousedown", (event) => {
                    event.preventDefault();
                    hidden.value = div.dataset.dn;
                    input.value = div.dataset.display || div.dataset.dn;
                    input.dataset.manual = "0";
                    clearResults();
                  });
                  results.appendChild(div);
                });
                results.hidden = results.children.length === 0;
              } catch (error) {
                console.error(error);
                clearResults();
              }
            }, 200);
          });
          input.addEventListener("blur", () => {
            setTimeout(clearResults, 150);
          });
          useDefaultBtn.addEventListener("click", () => {
            input.value = "";
            hidden.value = "";
            delete input.dataset.manual;
            clearResults();
          });
        };

    const createLicenseManager = ({
      catalogEl,
      hiddenContainer,
      statusEl,
      initialSelections = [],
      onManualChange,
    }) => {
      const skuMap = new Map();
      const cardViews = new Map();
      const selected = new Map();
      const selectionCache = new Map();
      let pendingSelections = Array.isArray(initialSelections) ? initialSelections.slice() : [];
      let catalogLoaded = false;

      const formatSkuName = (sku) =>
        sku?.productName || sku?.skuPartNumber || sku?.skuId || "License";

      const getAvailability = (sku) => {
        const enabled = Number(sku?.prepaidUnits?.enabled ?? 0);
        const consumed = Number(sku?.consumedUnits ?? 0);
        const available = Math.max(0, enabled - consumed);
        return { enabled, consumed, available };
      };

      const getDefaultDisabledPlans = (sku) => {
        const defaults = [];
        (sku?.servicePlans || []).forEach((plan) => {
          const planId = String(plan?.servicePlanId || "");
          if (!planId) {
            return;
          }
          const scope = String(plan?.appliesTo || "User").toLowerCase();
          const status = String(plan?.provisioningStatus || "").toLowerCase();
          if (scope !== "user" || status === "disabled") {
            defaults.push(planId);
          }
        });
        return defaults;
      };

      const setStatus = (message) => {
        if (statusEl) {
          statusEl.textContent = message || "";
        }
      };

      const updateStatus = () => {
        if (!statusEl) {
          return;
        }
        if (!selected.size) {
          statusEl.textContent = "No licenses selected.";
          return;
        }
        const labels = [];
        selected.forEach((_, skuId) => {
          const sku = skuMap.get(skuId);
          labels.push(formatSkuName(sku) || skuId);
        });
        statusEl.textContent = `${selected.size} license${selected.size === 1 ? "" : "s"} selected: ${labels.join(", ")}`;
      };

      const syncHidden = () => {
        if (!hiddenContainer) {
          return;
        }
        hiddenContainer.innerHTML = "";
        selected.forEach((entry, skuId) => {
          const input = document.createElement("input");
          input.type = "hidden";
          input.name = "license_selection";
          input.value = JSON.stringify({
            sku_id: skuId,
            disabled_plans: Array.from(entry.disabled),
          });
          hiddenContainer.appendChild(input);
        });
      };

      const renderPlansFor = (view, selection) => {
        const group = view.planGroup;
        group.innerHTML = "";
        if (!selection) {
          group.classList.add("is-empty");
          return;
        }
        const sku = view.sku;
        const plans = (sku?.servicePlans || [])
          .filter((plan) => plan?.servicePlanId)
          .sort((a, b) =>
            (a.servicePlanName || "").localeCompare(b.servicePlanName || "")
          );
        if (!plans.length) {
          group.classList.add("is-empty");
          return;
        }
        group.classList.remove("is-empty");
        plans.forEach((plan) => {
          const planId = String(plan.servicePlanId);
          const scope = String(plan.appliesTo || "User").toLowerCase();
          const isAssignable = scope === "user";

          const item = document.createElement("label");
          item.className = "license-plan-item";

          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.checked = !selection.disabled.has(planId);
          checkbox.disabled = !isAssignable;
          checkbox.addEventListener("change", (event) => {
            event.stopPropagation();
            if (checkbox.checked) {
              selection.disabled.delete(planId);
            } else {
              selection.disabled.add(planId);
            }
            syncHidden();
            updateStatus();
            if (typeof onManualChange === "function") {
              onManualChange();
            }
          });

          const info = document.createElement("div");
          const title = document.createElement("strong");
          title.textContent = plan.servicePlanName || planId;
          info.appendChild(title);

          const details = [];
          if (plan.provisioningStatus) {
            details.push(`Status: ${plan.provisioningStatus}`);
          }
          if (!isAssignable) {
            details.push(`Scope: ${plan.appliesTo || "Tenant"}`);
          }
          if (details.length) {
            const meta = document.createElement("small");
            meta.textContent = details.join(" | ");
            info.appendChild(meta);
          }

          item.appendChild(checkbox);
          item.appendChild(info);
          item.addEventListener("click", (event) => {
            event.stopPropagation();
          });
          group.appendChild(item);
        });
      };

      const applySelectionToView = (skuId) => {
        if (!catalogLoaded) {
          return;
        }
        const view = cardViews.get(skuId);
        if (!view) {
          return;
        }
        const selection = selected.get(skuId);
        view.checkbox.checked = Boolean(selection);
        view.card.classList.toggle("active", Boolean(selection));
        if (selection) {
          renderPlansFor(view, selection);
        } else {
          view.planGroup.innerHTML = "";
          view.planGroup.classList.add("is-empty");
        }
      };

      const syncSelectionsToViews = ({ skipManual = false } = {}) => {
        if (catalogLoaded) {
          cardViews.forEach((_, skuId) => applySelectionToView(skuId));
        }
        syncHidden();
        updateStatus();
        if (!skipManual && typeof onManualChange === "function") {
          onManualChange();
        }
      };

      const applyPendingSelections = ({ skipManual = false } = {}) => {
        if (!catalogLoaded) {
          return;
        }
        selected.clear();
        pendingSelections.forEach((entry) => {
          const skuId = String(entry?.sku_id || entry?.skuId || "").trim();
          if (!skuId || !skuMap.has(skuId)) {
            return;
          }
          const disabled = Array.isArray(entry?.disabled_plans || entry?.disabled_service_plans)
            ? entry.disabled_plans
            : [];
          selected.set(skuId, { disabled: new Set(disabled) });
        });
        pendingSelections = [];
        syncSelectionsToViews({ skipManual });
      };

      const setSelections = (entries, options = {}) => {
        const normalized = Array.isArray(entries)
          ? entries.map((entry) => ({
              sku_id: String(entry?.sku_id || entry?.skuId || "").trim(),
              disabled_plans: Array.isArray(entry?.disabled_plans || entry?.disabled_service_plans)
                ? entry.disabled_plans
                : [],
            }))
          : [];
        pendingSelections = normalized;
        if (catalogLoaded) {
          applyPendingSelections({ skipManual: options.skipManual });
        }
      };

      const getSelections = () =>
        Array.from(selected.entries()).map(([skuId, entry]) => ({
          sku_id: skuId,
          disabled_plans: Array.from(entry.disabled),
        }));

      const clearSelections = (options = {}) => {
        pendingSelections = [];
        selected.clear();
        selectionCache.clear();
        syncSelectionsToViews({ skipManual: options.skipManual });
      };

      const handleCheckboxToggle = (view) => {
        const skuId = view.sku.skuId;
        if (selected.has(skuId)) {
          const existing = selected.get(skuId);
          selectionCache.set(skuId, new Set(existing.disabled));
          selected.delete(skuId);
        } else {
          const sku = view.sku;
          const cached = selectionCache.get(skuId);
          const defaults = cached ? Array.from(cached) : getDefaultDisabledPlans(sku);
          selected.set(skuId, { disabled: new Set(defaults) });
          selectionCache.delete(skuId);
        }
        applySelectionToView(skuId);
        syncHidden();
        updateStatus();
        if (typeof onManualChange === "function") {
          onManualChange();
        }
      };

      const renderCatalog = () => {
        if (!catalogEl) {
          return;
        }
        catalogEl.innerHTML = "";
        cardViews.clear();
        const items = Array.from(skuMap.values()).sort((a, b) =>
          formatSkuName(a).localeCompare(formatSkuName(b))
        );
        items.forEach((sku) => {
          const skuId = String(sku.skuId);
          const availability = getAvailability(sku);

          const card = document.createElement("div");
          card.className = "license-card";
          if (availability.available <= 0) {
            card.classList.add("exhausted");
          }

          const header = document.createElement("div");
          header.className = "license-card-header";

          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.className = "license-card-checkbox";
          checkbox.id = `license-${skuId}`;

          const body = document.createElement("div");
          body.className = "license-card-body";

          const title = document.createElement("h4");
          title.textContent = formatSkuName(sku);
          body.appendChild(title);

          const part = document.createElement("div");
          part.className = "license-detail";
          part.textContent = sku.skuPartNumber || skuId;
          body.appendChild(part);

          if (sku.capabilityStatus) {
            const status = document.createElement("div");
            status.className = "license-detail";
            status.textContent = `Status: ${sku.capabilityStatus}`;
            body.appendChild(status);
          }

          const availabilityEl = document.createElement("div");
          availabilityEl.className = "license-availability";
          availabilityEl.textContent = `${availability.available} available (${availability.enabled} purchased)`;
          body.appendChild(availabilityEl);

          header.appendChild(checkbox);
          header.appendChild(body);

          const planGroup = document.createElement("div");
          planGroup.className = "license-plan-group is-empty";

          card.appendChild(header);
          card.appendChild(planGroup);
          catalogEl.appendChild(card);

          const view = { card, checkbox, planGroup, sku };
          cardViews.set(skuId, view);

          checkbox.addEventListener("change", () => handleCheckboxToggle(view));
          card.addEventListener("click", (event) => {
            if (event.target === checkbox) {
              return;
            }
            checkbox.checked = !checkbox.checked;
            handleCheckboxToggle(view);
          });
        });
      };

      const loadSkus = async () => {
        try {
          const response = await fetch("/api/m365/skus", {
            headers: { Accept: "application/json" },
          });
          const payload = await response.json();
          if (!response.ok) {
            throw new Error(payload.error || payload.message || "Unable to load license catalog.");
          }
          skuMap.clear();
          (payload.items || []).forEach((sku) => {
            if (sku?.skuId) {
              skuMap.set(String(sku.skuId), sku);
            }
          });
          catalogLoaded = true;
          renderCatalog();
          applyPendingSelections({ skipManual: true });
          if (!selected.size) {
            setStatus("Select licenses to assign.");
          }
          return payload;
        } catch (error) {
          setStatus(error instanceof Error ? error.message : String(error));
          throw error;
        }
      };

      setSelections(pendingSelections, { skipManual: true });

      return {
        loadSkus,
        setSelections,
        clear: (options = {}) => clearSelections(options),
        getSelections,
        getLabel: (skuId) => {
          const sku = skuMap.get(skuId);
          return sku ? formatSkuName(sku) : skuId;
        },
      };
    };

        const jobRoleInput = document.getElementById("job_role");
        const roleGroups = {{ role_groups|tojson|safe }};
        const initialGroups = {{ selected_groups|tojson|safe }};
        const licenseCatalog = document.getElementById("license_catalog");
        const licenseHiddenInputs = document.getElementById("license_hidden_inputs");
        const licenseStatusMessage = document.getElementById("license_status_message");
        const applyTemplateLicenseButton = document.getElementById("apply_template_license");
        const applyRoleLicenseButton = document.getElementById("apply_role_license");
        const clearLicenseButton = document.getElementById("clear_license");
        const applyRoleGroupsButton = document.getElementById("apply_role_groups");
        const groupTags = document.getElementById("group_tags");
        const groupSearchInput = document.getElementById("group_search");
        const groupResults = document.getElementById("group_results");
        const groupHiddenInputs = document.getElementById("group_hidden_inputs");
        const templateLicense = {{ template_license_selection|tojson|safe }};
        const initialLicenseSelections = {{ selected_license_selections|default([], true)|tojson|safe }};
        const roleLicenseDefaults = {{ role_license_defaults|tojson|safe }};
        let licenseManuallyEdited = initialLicenseSelections.length > 0;
        let licenseManager = null;


        const templateSelectionArray = Array.isArray(templateLicense?.licenses) && templateLicense.licenses.length
          ? templateLicense.licenses
              .map((entry) => ({
                sku_id: String(entry?.sku_id || entry?.skuId || entry?.id || "").trim(),
                disabled_plans: Array.isArray(entry?.disabled_plans || entry?.disabled_service_plans)
                  ? entry.disabled_plans
                  : [],
              }))
              .filter((item) => item.sku_id)
          : templateLicense?.license_sku_id
          ? [
              {
                sku_id: templateLicense.license_sku_id,
                disabled_plans: templateLicense.disabled_service_plans || [],
              },
            ]
          : [];

        const applyRoleLicenseDefaults = (force = false) => {
          if (!licenseManager || !jobRoleInput) {
            return;
          }
          const roleName = jobRoleInput.value?.trim() || "";
          const defaultsEntry = roleLicenseDefaults[roleName];
          const defaults = defaultsEntry?.licenses || [];
          if (!defaults.length) {
            if (force) {
              licenseManager.clear({ skipManual: true });
              licenseManuallyEdited = false;
            }
            return;
          }
          if (!force && licenseManuallyEdited) {
            return;
          }
          licenseManager.setSelections(defaults, { skipManual: true });
          licenseManuallyEdited = false;
        };

        const applyTemplateLicenseDefaults = () => {
          if (!licenseManager || !templateSelectionArray.length) {
            return;
          }
          licenseManager.setSelections(templateSelectionArray, { skipManual: true });
          licenseManuallyEdited = false;
        };

        if (licenseCatalog && licenseHiddenInputs) {
          licenseManager = createLicenseManager({
            catalogEl: licenseCatalog,
            hiddenContainer: licenseHiddenInputs,
            statusEl: licenseStatusMessage,
            initialSelections: initialLicenseSelections,
            onManualChange: () => {
              licenseManuallyEdited = true;
            },
          });

          licenseManager
            .loadSkus()
            .then(() => {
              if (initialLicenseSelections.length) {
                licenseManager.setSelections(initialLicenseSelections, { skipManual: true });
                licenseManuallyEdited = true;
              } else if (templateSelectionArray.length) {
                applyTemplateLicenseDefaults();
              } else {
                applyRoleLicenseDefaults(true);
              }
            })
            .catch(() => {
              /* errors already surfaced via status message */
            });
        }

        applyTemplateLicenseButton?.addEventListener("click", () => {
          applyTemplateLicenseDefaults();
        });

        applyRoleLicenseButton?.addEventListener("click", () => {
          if (!licenseManager) {
            return;
          }
          const roleName = jobRoleInput?.value?.trim() || "";
          const defaultsEntry = roleLicenseDefaults[roleName];
          licenseManager.setSelections(defaultsEntry?.licenses || [], { skipManual: true });
          licenseManuallyEdited = false;
        });

        clearLicenseButton?.addEventListener("click", () => {
          if (!licenseManager) {
            return;
          }
          licenseManager.clear();
          licenseManuallyEdited = true;
        });
        const formatGroupLabel = (value, friendly) => {
          if (friendly) {
            return friendly;
          }
          if (!value) {
            return "";
          }
          const match = String(value).match(/CN=([^,]+)/i);
          return match ? match[1] : value;
        };
        const selectedGroupMap = new Map();

        const renderGroups = () => {
          if (!groupTags || !groupHiddenInputs) {
            return;
          }
          groupTags.innerHTML = "";
          groupHiddenInputs.innerHTML = "";
          selectedGroupMap.forEach(({ value, label }) => {
            const tag = document.createElement("span");
            tag.className = "tag";
            const labelSpan = document.createElement("span");
            labelSpan.textContent = label;
            const removeBtn = document.createElement("button");
            removeBtn.type = "button";
            removeBtn.className = "tag-remove";
            removeBtn.innerHTML = "&times;";
            removeBtn.setAttribute("aria-label", `Remove ${label}`);
            removeBtn.addEventListener("click", () => {
              selectedGroupMap.delete(value);
              renderGroups();
            });
            tag.appendChild(labelSpan);
            tag.appendChild(removeBtn);
            groupTags.appendChild(tag);

            const hidden = document.createElement("input");
            hidden.type = "hidden";
            hidden.name = "groups";
            hidden.value = value;
            groupHiddenInputs.appendChild(hidden);
          });
          groupTags.hidden = selectedGroupMap.size === 0;
        };

        const addGroup = (value, label, silent = false) => {
          if (!value || selectedGroupMap.has(value)) {
            return;
          }
          selectedGroupMap.set(value, {
            value,
            label: formatGroupLabel(value, label),
          });
          if (!silent) {
            renderGroups();
          }
        };

        const setGroups = (values) => {
          selectedGroupMap.clear();
          (values || []).forEach((value) => {
            if (!value) {
              return;
            }
            addGroup(value, undefined, true);
          });
          renderGroups();
        };

        setGroups(Array.isArray(initialGroups) ? initialGroups : []);

        const applyRoleGroups = () => {
          if (!jobRoleInput) {
            return;
          }
          const roleName = jobRoleInput.value.trim();
          if (!roleName) {
            renderGroups();
            return;
          }
          const defaults = roleGroups[roleName] || [];
          let changed = false;
          defaults.forEach((value) => {
            if (!value) {
              return;
            }
            if (!selectedGroupMap.has(value)) {
              addGroup(value, undefined, true);
              changed = true;
            }
          });
          if (changed) {
            renderGroups();
          }
        };

        const originalApplyRoleGroups = applyRoleGroups;
        const applyRoleGroupsWithLicense = (forceLicense = false) => {
          originalApplyRoleGroups();
          if (forceLicense) {
            applyRoleLicenseDefaults(true);
          } else {
            applyRoleLicenseDefaults();
          }
        };

        jobRoleInput?.addEventListener("change", () => applyRoleGroupsWithLicense(false));
        jobRoleInput?.addEventListener("blur", () => applyRoleGroupsWithLicense(false));
        applyRoleGroupsButton?.addEventListener("click", () => {
          applyRoleGroupsWithLicense(true);
          groupSearchInput?.focus();
        });

        let groupSearchTimer;
        const clearGroupResults = () => {
          if (!groupResults) {
            return;
          }
          groupResults.innerHTML = "";
          groupResults.hidden = true;
        };

        groupSearchInput?.addEventListener("input", () => {
          if (!groupSearchInput) {
            return;
          }
          const term = groupSearchInput.value.trim();
          clearTimeout(groupSearchTimer);
          if (!term) {
            clearGroupResults();
            return;
          }
          groupSearchTimer = window.setTimeout(async () => {
            try {
              const payload = await fetchJson("/api/groups", term);
              const items = payload.items || [];
              if (!groupResults) {
                return;
              }
              groupResults.innerHTML = "";
              items.forEach((item) => {
                const dn = item.distinguishedName;
                if (!dn) {
                  return;
                }
                const div = document.createElement("div");
                div.className = "autocomplete-item";
                div.textContent = item.name || formatGroupLabel(dn);
                div.addEventListener("mousedown", (event) => {
                  event.preventDefault();
                  addGroup(dn, item.name || formatGroupLabel(dn));
                  renderGroups();
                  if (groupSearchInput) {
                    groupSearchInput.value = "";
                  }
                  clearGroupResults();
                });
                groupResults.appendChild(div);
              });
              groupResults.hidden = groupResults.children.length === 0;
            } catch (error) {
              console.error(error);
              clearGroupResults();
            }
          }, 200);
        });
        groupSearchInput?.addEventListener("keydown", (event) => {
          if (event.key === "Enter") {
            event.preventDefault();
          }
        });
        groupSearchInput?.addEventListener("blur", () => {
          window.setTimeout(clearGroupResults, 150);
        });

        if (!initialGroups.length) {
          applyRoleGroupsWithLicense(true);
        } else if (!licenseManuallyEdited) {
          applyRoleLicenseDefaults(true);
        }

        const domain = {{ (email_domain or '')|tojson|safe }};
        const emailInput = document.getElementById("email");
        const usernameInput = document.getElementById("username");
        const firstNameInput = document.getElementById("first_name");
        const lastNameInput = document.getElementById("last_name");

        const formatPersonName = (value) =>
          (value || "")
            .toLowerCase()
            .replace(/(^|[\s\-'])([a-z])/g, (match, separator, char) => `${separator}${char.toUpperCase()}`);

        const applyPersonNameFormatting = (input) => {
          if (!input) {
            return;
          }
          const original = input.value;
          const formatted = formatPersonName(original);
          if (formatted !== original) {
            const start = input.selectionStart;
            const end = input.selectionEnd;
            input.value = formatted;
            if (typeof start === "number" && typeof end === "number") {
              input.setSelectionRange(start, end);
            }
          }
        };
        const updateEmail = () => {
          if (!domain || !emailInput || !usernameInput) {
            return;
          }
          const username = usernameInput.value.trim();
          emailInput.value = username ? `${username}@${domain}` : "";
        };

        let usernameManuallyEdited = false;
        if (usernameInput) {
          usernameManuallyEdited = usernameInput.dataset.manual === "1";
          usernameInput.addEventListener("input", () => {
            usernameManuallyEdited = true;
            usernameInput.dataset.manual = "1";
            updateEmail();
          });
        }

        const sanitizeForUsername = (value) => {
          if (!value) {
            return "";
          }
          return value
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .replace(/[^a-z0-9]/gi, "")
            .toLowerCase();
        };

        const formatUsernamePart = (value) => {
          const slug = sanitizeForUsername(value);
          if (!slug) {
            return "";
          }
          return slug.charAt(0).toUpperCase() + slug.slice(1);
        };

        const updateUsernameIfNeeded = () => {
          if (!usernameInput || usernameManuallyEdited) {
            return;
          }
          const first = formatUsernamePart(firstNameInput?.value || "");
          const last = formatUsernamePart(lastNameInput?.value || "");
          const parts = [first, last].filter(Boolean);
          const suggestion =
            parts.length === 0 ? "" : parts.length === 1 ? parts[0] : `${parts[0]}.${parts[1]}`;
          usernameInput.value = suggestion;
          updateEmail();
        };

        firstNameInput?.addEventListener("input", () => {
          applyPersonNameFormatting(firstNameInput);
          updateUsernameIfNeeded();
        });
        lastNameInput?.addEventListener("input", () => {
          applyPersonNameFormatting(lastNameInput);
          updateUsernameIfNeeded();
        });
        firstNameInput?.addEventListener("blur", () => applyPersonNameFormatting(firstNameInput));
        lastNameInput?.addEventListener("blur", () => applyPersonNameFormatting(lastNameInput));

        wireDatalist(
          "job_role",
          "clone-job-role-suggestions",
          "/api/job-titles",
          {{ job_titles|tojson|safe }},
          { minLength: 1, preload: true, limit: 500 }
        );
        wireDatalist(
          "user_ou",
          "clone-ou-suggestions",
          "/api/ous",
          {{ ous|tojson|safe }}
        );
        wireDatalist(
          "company",
          "clone-company-suggestions",
          "/api/companies",
          {{ companies|tojson|safe }}
        );
        wireDatalist(
          "office",
          "clone-office-suggestions",
          "/api/offices",
          {{ offices|tojson|safe }}
        );
        wireManagerAutocomplete();
        applyPersonNameFormatting(firstNameInput);
        applyPersonNameFormatting(lastNameInput);
        updateUsernameIfNeeded();
        if (!emailInput?.value) {
          updateEmail();
        }
      });
    </script>
  {% endif %}
{% endblock %}
