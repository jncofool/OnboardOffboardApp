{% extends "base.html" %}
{% block title %}Clone User Â· Onboard &amp; Offboard{% endblock %}
{% block content %}
  <h1>Clone an Existing User</h1>
  <form method="get" class="field" action="{{ url_for('clone_user') }}">
    <label for="query">Search Directory</label>
    <div style="display:flex; gap:0.5rem;">
      <input id="query" name="query" type="text" value="{{ query }}" placeholder="Search by name, username, or email" />
      <button type="submit">Search</button>
    </div>
  </form>

  {% if search_results %}
    <h2>Results</h2>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Username</th>
          <th>Email</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for user in search_results %}
          <tr>
            <td>{{ user.get('displayName') }}</td>
            <td>{{ user.get('sAMAccountName') }}</td>
            <td>{{ user.get('mail') }}</td>
            <td><a class="button secondary" href="{{ url_for('clone_user', user_dn=user.get('distinguishedName')) }}">Use as template</a></td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% elif query %}
    <p>No users matched "{{ query }}".</p>
  {% endif %}

  {% if selected_user %}
    <h2 style="margin-top: 2rem;">Clone Details</h2>
    <form method="post">
      <input type="hidden" name="source_dn" value="{{ selected_user.get('distinguishedName') }}" />
      <div class="field">
        <label for="first_name">New First Name</label>
        <input id="first_name" name="first_name" type="text" value="{{ request.form.first_name or '' }}" required />
      </div>
      <div class="field">
        <label for="last_name">New Last Name</label>
        <input id="last_name" name="last_name" type="text" value="{{ request.form.last_name or '' }}" required />
      </div>
      <div class="field">
        <label for="username">New Username (sAMAccountName)</label>
        <input id="username" name="username" type="text" value="{{ request.form.username or '' }}" required />
      </div>
      <div class="field">
        <label for="email">New Email</label>
        <input id="email" name="email" type="email" value="{{ request.form.email or '' }}" required />
      </div>
      <div class="field">
        <label for="job_role">Target Job Role</label>
        <select id="job_role" name="job_role" required>
          <option value="" disabled {% if not request.form.job_role %}selected{% endif %}>Select a role</option>
          {% for name, role in job_roles.items() %}
            <option value="{{ name }}" {% if request.form.job_role == name %}selected{% endif %}>{{ name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="field">
        <label for="password">Temporary Password (optional)</label>
        <input id="password" name="password" type="password" />
      </div>
      <div class="field">
        <label for="manager_dn">Manager</label>
        <select id="manager_dn" name="manager_dn">
          <option value="" {% if not (request.form.manager_dn or default_manager) %}selected{% endif %}>Use job role default</option>
          {% for manager in managers %}
            {% set dn = manager.get('distinguishedName') %}
            <option value="{{ dn }}" {% if (request.form.manager_dn or default_manager) == dn %}selected{% endif %}>
              {{ manager.get('displayName') or dn }} ({{ manager.get('title') or 'No title' }})
            </option>
          {% endfor %}
        </select>
      </div>
      <div class="field">
        <label for="user_ou">Organizational Unit</label>
        <select id="user_ou" name="user_ou">
          <option value="" {% if not (request.form.user_ou or default_ou) %}selected{% endif %}>Use job role default</option>
          {% for ou in ous %}
            {% set selected_value = request.form.user_ou or default_ou %}
            <option value="{{ ou }}" {% if selected_value == ou %}selected{% endif %}>{{ ou }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="field">
        <label for="attributes">Attributes (key=value per line)</label>
        <textarea id="attributes" name="attributes">{{ request.form.attributes or default_attributes }}</textarea>
      </div>
      <div class="field">
        <button type="submit">Clone Account &amp; Sync</button>
      </div>
    </form>
  {% endif %}
{% endblock %}
