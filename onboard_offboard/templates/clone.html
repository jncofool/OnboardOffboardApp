{% extends "base.html" %}
{% block title %}Clone User Â· Onboard &amp; Offboard{% endblock %}
{% block content %}
  <h1>Clone an Existing User</h1>
  <form method="get" class="field" action="{{ url_for('clone_user') }}">
    <label for="query">Search Directory</label>
    <div style="display:flex; gap:0.5rem;">
      <input id="query" name="query" type="text" value="{{ query }}" placeholder="Search by name, username, or email" />
      <button type="submit">Search</button>
    </div>
  </form>

  {% if search_results %}
    <h2>Results</h2>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Username</th>
          <th>Email</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for user in search_results %}
          <tr>
            <td>{{ user.get('displayName') }}</td>
            <td>{{ user.get('sAMAccountName') }}</td>
            <td>{{ user.get('mail') }}</td>
            <td><a class="button secondary" href="{{ url_for('clone_user', user_dn=user.get('distinguishedName')) }}">Use as template</a></td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% elif query %}
    <p>No users matched "{{ query }}".</p>
  {% endif %}

  {% if selected_user %}
    <h2 style="margin-top: 2rem;">Clone Details</h2>
    <form method="post">
      <input type="hidden" name="source_dn" value="{{ selected_user.get('distinguishedName') }}" />
      <div class="field">
        <label for="first_name">New First Name</label>
        <input id="first_name" name="first_name" type="text" value="{{ request.form.first_name or '' }}" required />
      </div>
      <div class="field">
        <label for="last_name">New Last Name</label>
        <input id="last_name" name="last_name" type="text" value="{{ request.form.last_name or '' }}" required />
      </div>
      <div class="field">
        <label for="username">New Username (sAMAccountName)</label>
        <input
          id="username"
          name="username"
          type="text"
          value="{{ request.form.username or generated_username or '' }}"
          data-manual="{{ '1' if request.form.username else '0' }}"
          required
          autocomplete="off"
        />
      </div>
      <div class="field">
        <label for="email">New Email</label>
        <input
          id="email"
          name="email"
          type="email"
          value="{{ request.form.email or generated_email or '' }}"
          required
          {% if email_domain %}readonly{% endif %}
        />
      </div>
      <div class="field">
        <label for="telephone_number">Telephone Number (optional)</label>
        <input
          id="telephone_number"
          name="telephone_number"
          type="tel"
          value="{{ request.form.telephone_number or '' }}"
          placeholder="+16125551234"
          autocomplete="off"
        />
      </div>
      <div class="field">
        <label for="mobile_number">Mobile Number (optional)</label>
        <input
          id="mobile_number"
          name="mobile_number"
          type="tel"
          value="{{ request.form.mobile_number or '' }}"
          placeholder="+16125551234"
          autocomplete="off"
        />
      </div>
      <div class="field">
        <label for="job_role">Target Job Role</label>
        <input
          id="job_role"
          name="job_role"
          type="text"
          list="clone-job-role-suggestions"
          value="{{ request.form.job_role or prefilled_job_role or '' }}"
          placeholder="Start typing a job title"
          required
          autocomplete="off"
        />
        <datalist id="clone-job-role-suggestions">
          {% for name in job_titles %}
            <option value="{{ name }}"></option>
          {% endfor %}
        </datalist>
        <div class="hint">Pick an existing role or enter a new job title.</div>
      </div>
      <div class="field">
        <label for="group_search">Groups</label>
        <div id="group_tags" class="tag-list"></div>
        <div class="autocomplete">
          <input
            id="group_search"
            type="text"
            placeholder="Search for groups"
            autocomplete="off"
          />
          <div class="autocomplete-results" id="group_results" hidden></div>
        </div>
        <button type="button" class="inline-button" id="apply_role_groups">Apply role groups</button>
        <div class="hint">
          Groups from the template user and selected role are listed here. Search to add more or remove tags to exclude.
        </div>
        <div id="group_hidden_inputs"></div>
      </div>
      {% if m365_status.configured %}
        <div class="field" id="license_field">
          <label for="license_sku">Microsoft 365 License</label>
          <select id="license_sku" name="license_sku">
            <option value="">Do not assign a license</option>
          </select>
          <div class="field-actions">
            {% if template_license_selection %}
              <button type="button" class="inline-button" id="apply_template_license">Use template license</button>
            {% endif %}
            <button type="button" class="inline-button" id="apply_role_license">Use role default</button>
            <button type="button" class="inline-button" id="clear_license">Clear license</button>
          </div>
          <small id="license_status_message" class="hint"></small>
          {% if template_license_selection and template_license_selection.assigned_count|int > 1 %}
            <small class="hint">
              Template user has multiple licenses; the first assignment is preselected.
            </small>
          {% endif %}
        </div>
        <div class="field" id="service_plan_field" hidden>
          <label>Apps</label>
          <div id="license_plan_list" class="checkbox-grid"></div>
          <div id="license_hidden_inputs"></div>
        </div>
      {% else %}
        <div class="status-card">
          <span class="badge">Not Configured</span>
          <p>
            Microsoft 365 credentials have not been configured. Add them on the Configuration page to manage licenses during cloning.
          </p>
        </div>
      {% endif %}
      <div class="field">
        <label for="password">Temporary Password (optional)</label>
        <input id="password" name="password" type="password" />
      </div>
      <div class="field">
        <label for="manager_dn">Manager</label>
        <div class="autocomplete">
          <input
            id="manager_search"
            name="manager_search"
            type="text"
            value="{{ request.form.manager_search or default_manager_label or '' }}"
            placeholder="Search by name, username, or email"
            autocomplete="off"
          />
          <input
            id="manager_dn"
            name="manager_dn"
            type="hidden"
            value="{{ request.form.manager_dn or default_manager or '' }}"
          />
          <div class="autocomplete-results" id="manager_results" hidden></div>
        </div>
        <button type="button" class="inline-button" id="manager_use_default">Use job role default</button>
        <div class="hint">Leave blank to apply the job role&rsquo;s default manager.</div>
      </div>
      <div class="field">
        <label for="company">Company</label>
        <input
          id="company"
          name="company"
          type="text"
          list="clone-company-suggestions"
          value="{{ request.form.company or selected_user.get('company') or '' }}"
          placeholder="Select or type a company"
          autocomplete="off"
        />
        <datalist id="clone-company-suggestions">
          {% for company in companies %}
            <option value="{{ company }}"></option>
          {% endfor %}
        </datalist>
      </div>
      <div class="field">
        <label for="office">Office (optional)</label>
        <input
          id="office"
          name="office"
          type="text"
          list="clone-office-suggestions"
          value="{{ request.form.office or selected_user.get('physicalDeliveryOfficeName') or '' }}"
          placeholder="Select or type an office"
          autocomplete="off"
        />
        <datalist id="clone-office-suggestions">
          {% for office in offices %}
            <option value="{{ office }}"></option>
          {% endfor %}
        </datalist>
      </div>
      <div class="field">
        <label for="user_ou">Organizational Unit</label>
        <input
          id="user_ou"
          name="user_ou"
          type="text"
          list="clone-ou-suggestions"
          value="{{ request.form.user_ou or default_ou or '' }}"
          placeholder="Leave blank to use the job role default"
          autocomplete="off"
        />
        <datalist id="clone-ou-suggestions">
          {% for ou in ous %}
            <option value="{{ ou }}"></option>
          {% endfor %}
        </datalist>
      </div>
      <div class="field">
        <label for="attributes">Attributes (key=value per line)</label>
        <textarea id="attributes" name="attributes">{{ request.form.attributes or default_attributes }}</textarea>
      </div>
      <div class="field">
        <button type="submit">Clone Account &amp; Sync</button>
      </div>
    </form>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const fetchJson = async (endpoint, query, limit = 20) => {
          const url = new URL(endpoint, window.location.origin);
          if (query) {
            url.searchParams.set("q", query);
          }
          if (limit) {
            url.searchParams.set("limit", limit);
          }
          const response = await fetch(url.toString(), {
            headers: { Accept: "application/json" },
          });
          if (!response.ok) {
            throw new Error(`Directory lookup failed (${response.status})`);
          }
          return response.json();
        };

        const wireDatalist = (inputId, datalistId, endpoint, initial = [], options = {}) => {
          const input = document.getElementById(inputId);
          const datalist = document.getElementById(datalistId);
          if (!input || !datalist) {
            return { setStatic: () => {} };
          }
          const minLength =
            typeof options.minLength === "number" && options.minLength >= 0
              ? options.minLength
              : 2;
          const preload = Boolean(options.preload);
          const requestLimit =
            typeof options.limit === "number" && options.limit > 0 ? options.limit : 200;
          let staticItems = Array.from(
            new Set((initial || []).map((item) => (item || "").trim()).filter(Boolean))
          );

          const render = (dynamicItems = []) => {
            const seen = new Set();
            datalist.innerHTML = "";
            const addOption = (value) => {
              const normalized = (value || "").trim();
              if (!normalized || seen.has(normalized)) {
                return;
              }
              const option = document.createElement("option");
              option.value = normalized;
              datalist.appendChild(option);
              seen.add(normalized);
            };
            staticItems.forEach(addOption);
            (dynamicItems || []).forEach(addOption);
          };
          render();

          const fetchAndRender = async (query) => {
            try {
              const payload = await fetchJson(endpoint, query, requestLimit);
              render(payload.items || []);
            } catch (error) {
              console.error(error);
            }
          };

          let timer;
          input.addEventListener("input", () => {
            clearTimeout(timer);
            const value = input.value.trim();
            if (value.length < minLength) {
              render();
              return;
            }
            timer = setTimeout(async () => {
              fetchAndRender(value);
            }, 200);
          });

          if (preload) {
            input.addEventListener("focus", () => {
              fetchAndRender(input.value.trim());
            });
            fetchAndRender("");
          }

          return {
            setStatic(items) {
              staticItems = Array.from(
                new Set((items || []).map((item) => (item || "").trim()).filter(Boolean))
              );
              render();
            },
          };
        };

        const wireManagerAutocomplete = () => {
          const input = document.getElementById("manager_search");
          const hidden = document.getElementById("manager_dn");
          const results = document.getElementById("manager_results");
          const useDefaultBtn = document.getElementById("manager_use_default");
          if (!input || !hidden || !results || !useDefaultBtn) {
            return;
          }
          const clearResults = () => {
            results.innerHTML = "";
            results.hidden = true;
          };
          let timer;
          input.addEventListener("input", () => {
            if (!input.dataset.manual) {
              hidden.value = "";
            }
            input.dataset.manual = "1";
            clearTimeout(timer);
            const value = input.value.trim();
            if (value.length < 2) {
              clearResults();
              return;
            }
            timer = setTimeout(async () => {
              try {
                const payload = await fetchJson("/api/managers", value);
                results.innerHTML = "";
                (payload.items || []).forEach((item) => {
                  if (!item || !item.distinguishedName) {
                    return;
                  }
                  const div = document.createElement("div");
                  div.className = "autocomplete-item";
                  const segments = [];
                  if (item.displayName) {
                    segments.push(item.displayName);
                  }
                  if (item.title) {
                    segments.push(`(${item.title})`);
                  }
                  if (item.mail) {
                    segments.push(item.mail);
                  }
                  if (item.sAMAccountName) {
                    segments.push(item.sAMAccountName);
                  }
                  if (item.userPrincipalName && item.userPrincipalName !== item.mail) {
                    segments.push(item.userPrincipalName);
                  }
                  const label = segments.join(" ").trim();
                  div.textContent = label || item.distinguishedName;
                  div.dataset.dn = item.distinguishedName;
                  div.dataset.display = label;
                  div.addEventListener("mousedown", (event) => {
                    event.preventDefault();
                    hidden.value = div.dataset.dn;
                    input.value = div.dataset.display || div.dataset.dn;
                    input.dataset.manual = "0";
                    clearResults();
                  });
                  results.appendChild(div);
                });
                results.hidden = results.children.length === 0;
              } catch (error) {
                console.error(error);
                clearResults();
              }
            }, 200);
          });
          input.addEventListener("blur", () => {
            setTimeout(clearResults, 150);
          });
          useDefaultBtn.addEventListener("click", () => {
            input.value = "";
            hidden.value = "";
            delete input.dataset.manual;
            clearResults();
          });
        };

        const jobRoleInput = document.getElementById("job_role");
        const roleGroups = {{ role_groups|tojson }};
        const initialGroups = {{ selected_groups|tojson }};
        const roleLicenseDefaults = {{ role_license_defaults|tojson }};
        const initialLicenseSku = {{ selected_license|tojson }};
        const initialDisabledPlans = {{ selected_disabled_plans|tojson }};
        const templateLicense = {{ template_license_selection|tojson }};
        const m365Status = {{ m365_status|tojson }};
        const licenseSelect = document.getElementById("license_sku");
        const licensePlanList = document.getElementById("license_plan_list");
        const licenseHiddenInputs = document.getElementById("license_hidden_inputs");
        const licenseStatusMessage = document.getElementById("license_status_message");
        const licensePlanField = document.getElementById("service_plan_field");
        const applyTemplateLicenseButton = document.getElementById("apply_template_license");
        const applyRoleLicenseButton = document.getElementById("apply_role_license");
        const clearLicenseButton = document.getElementById("clear_license");
        let licensePicker = null;
        let licenseManuallyEdited = Boolean(initialLicenseSku);
        const groupTags = document.getElementById("group_tags");
        const groupSearchInput = document.getElementById("group_search");
        const groupResults = document.getElementById("group_results");
        const groupHiddenInputs = document.getElementById("group_hidden_inputs");
        const applyRoleGroupsButton = document.getElementById("apply_role_groups");

        function createLicensePicker({
          selectEl,
          planContainer,
          hiddenContainer,
          statusEl,
          planField,
          onManualChange,
        }) {
          const skuMap = new Map();
          let currentSku = "";
          let disabledPlans = new Set();

          const setStatus = (message) => {
            if (statusEl) {
              statusEl.textContent = message || "";
            }
          };

          const syncHidden = () => {
            if (!hiddenContainer) {
              return;
            }
            hiddenContainer.innerHTML = "";
            disabledPlans.forEach((planId) => {
              if (!planId) {
                return;
              }
              const input = document.createElement("input");
              input.type = "hidden";
              input.name = "license_disabled_plan";
              input.value = planId;
              hiddenContainer.appendChild(input);
            });
          };

          const formatAvailability = (sku) => {
            if (!sku) {
              return "";
            }
            const enabled = Number(sku?.prepaidUnits?.enabled ?? 0);
            const consumed = Number(sku?.consumedUnits ?? 0);
            const available = Math.max(0, enabled - consumed);
            const name = sku?.skuPartNumber || sku?.skuId || "License";
            return `${name} – ${available} available (${enabled} purchased)`;
          };

          const renderPlans = () => {
            if (!planContainer) {
              return;
            }
            const field = planField || planContainer.closest(".field");
            planContainer.innerHTML = "";
            if (!currentSku || !skuMap.has(currentSku)) {
              if (field) {
                field.hidden = true;
              }
              syncHidden();
              if (skuMap.size) {
                setStatus("Select a license to customise apps.");
              }
              return;
            }
            const sku = skuMap.get(currentSku);
            const plans = (sku?.servicePlans || []).filter((plan) => plan?.servicePlanId);
            plans.sort((a, b) =>
              (a.servicePlanName || "").localeCompare(b.servicePlanName || "")
            );
            if (field) {
              field.hidden = plans.length === 0;
            }
            plans.forEach((plan) => {
              const planId = String(plan.servicePlanId);
              const wrapper = document.createElement("label");
              wrapper.className = "checkbox-card";
              const checkbox = document.createElement("input");
              checkbox.type = "checkbox";
              checkbox.value = planId;
              checkbox.checked = !disabledPlans.has(planId);
              checkbox.addEventListener("change", (event) => {
                if (event.target.checked) {
                  disabledPlans.delete(planId);
                } else {
                  disabledPlans.add(planId);
                }
                syncHidden();
              });
              const label = document.createElement("span");
              label.className = "checkbox-card-label";
              label.textContent = plan.servicePlanName || plan.servicePlanId;
              const status = document.createElement("span");
              status.className = "checkbox-card-status";
              status.textContent =
                plan.provisioningStatus && plan.provisioningStatus !== "Success"
                  ? plan.provisioningStatus
                  : "";

              wrapper.appendChild(checkbox);
              wrapper.appendChild(label);
              if (status.textContent) {
                wrapper.appendChild(status);
              }
              planContainer.appendChild(wrapper);
            });
            syncHidden();
            setStatus(formatAvailability(sku));
          };

          const populateSelect = () => {
            if (!selectEl) {
              return;
            }
            selectEl.innerHTML = "";
            const defaultOption = document.createElement("option");
            defaultOption.value = "";
            defaultOption.textContent = "Do not assign a license";
            selectEl.appendChild(defaultOption);
            const entries = Array.from(skuMap.values());
            entries.sort((a, b) =>
              (a.skuPartNumber || "").localeCompare(b.skuPartNumber || "")
            );
            entries.forEach((sku) => {
              const option = document.createElement("option");
              option.value = sku.skuId || sku.id;
              option.textContent = formatAvailability(sku);
              selectEl.appendChild(option);
            });
            if (!entries.length) {
              setStatus("No licenses available. Refresh the catalog on the Configuration page.");
            }
          };

          const setValue = (skuId, disabledList, { skipManual = false } = {}) => {
            currentSku = skuId || "";
            disabledPlans = new Set(disabledList || []);
            if (selectEl) {
              selectEl.value = currentSku;
            }
            if (!skipManual && onManualChange) {
              onManualChange();
            }
            renderPlans();
          };

          const loadSkus = async () => {
            if (!m365Status?.configured) {
              setStatus("Licensing is not configured.");
              return;
            }
            try {
              const response = await fetch("/api/m365/skus", {
                headers: { Accept: "application/json" },
              });
              const payload = await response.json();
              if (!response.ok) {
                throw new Error(payload.error || payload.message || "Unable to load license catalog.");
              }
              skuMap.clear();
              (payload.items || []).forEach((sku) => {
                if (!sku || !sku.skuId) {
                  return;
                }
                skuMap.set(sku.skuId, sku);
              });
              populateSelect();
              renderPlans();
              if (!skuMap.size) {
                setStatus("No licenses available. Refresh the catalog on the Configuration page.");
              } else if (!currentSku) {
                setStatus("Select a license to customise apps.");
              }
              return payload;
            } catch (error) {
              setStatus(error instanceof Error ? error.message : String(error));
              throw error;
            }
          };

          if (selectEl) {
            selectEl.addEventListener("change", (event) => {
              const value = event.target.value;
              currentSku = value;
              disabledPlans = new Set();
              if (onManualChange) {
                onManualChange();
              }
              renderPlans();
            });
          }

          return {
            loadSkus,
            setValue: (skuId, disabledList, skipManual = false) =>
              setValue(skuId, disabledList, { skipManual }),
            getValue: () => ({
              skuId: currentSku,
              disabledPlans: Array.from(disabledPlans),
            }),
            getLabel: (skuId) => {
              const sku = skuMap.get(skuId);
              return sku ? sku.skuPartNumber || sku.skuId : skuId;
            },
          };
        }

        function applyRoleLicenseDefaults(force = false) {
          if (!licensePicker || !jobRoleInput) {
            return;
          }
          const roleName = jobRoleInput.value.trim();
          if (!roleName) {
            return;
          }
          const defaults = roleLicenseDefaults[roleName];
          if (!defaults) {
            if (force) {
              licensePicker.setValue("", [], true);
              licenseManuallyEdited = false;
            }
            return;
          }
          if (!force && licenseManuallyEdited) {
            return;
          }
          licensePicker.setValue(
            defaults.license_sku_id || "",
            defaults.disabled_service_plans || [],
            true
          );
          licenseManuallyEdited = false;
        }

        function applyTemplateLicenseDefaults() {
          if (!licensePicker || !templateLicense?.license_sku_id) {
            return;
          }
          licensePicker.setValue(
            templateLicense.license_sku_id,
            templateLicense.disabled_service_plans || [],
            true
          );
          licenseManuallyEdited = false;
        }

        function updateTemplateLicenseButton() {
          if (!applyTemplateLicenseButton) {
            return;
          }
          const hasTemplate = Boolean(templateLicense?.license_sku_id);
          applyTemplateLicenseButton.disabled = !hasTemplate;
        }

        if (licenseSelect) {
          licensePicker = createLicensePicker({
            selectEl: licenseSelect,
            planContainer: licensePlanList,
            hiddenContainer: licenseHiddenInputs,
            statusEl: licenseStatusMessage,
            planField: licensePlanField,
            onManualChange: () => {
              licenseManuallyEdited = true;
            },
          });
          licensePicker
            .loadSkus()
            .then(() => {
              if (initialLicenseSku) {
                licensePicker.setValue(initialLicenseSku, initialDisabledPlans, true);
              } else if (templateLicense?.license_sku_id) {
                applyTemplateLicenseDefaults();
              } else {
                applyRoleLicenseDefaults(true);
              }
              updateTemplateLicenseButton();
            })
            .catch((error) => console.error(error));
        }

        applyTemplateLicenseButton?.addEventListener("click", () => {
          applyTemplateLicenseDefaults();
          licenseManuallyEdited = true;
        });
        applyRoleLicenseButton?.addEventListener("click", () => {
          applyRoleLicenseDefaults(true);
        });
        clearLicenseButton?.addEventListener("click", () => {
          if (!licensePicker) {
            return;
          }
          licensePicker.setValue("", [], true);
          licenseManuallyEdited = true;
        });
        updateTemplateLicenseButton();

        const formatGroupLabel = (value, friendly) => {
          if (friendly) {
            return friendly;
          }
          if (!value) {
            return "";
          }
          const match = value.match(/CN=([^,]+)/i);
          return match ? match[1] : value;
        };

        const selectedGroupMap = new Map();

        const renderGroups = () => {
          if (!groupTags || !groupHiddenInputs) {
            return;
          }
          groupTags.innerHTML = "";
          groupHiddenInputs.innerHTML = "";
          selectedGroupMap.forEach(({ value, label }) => {
            const tag = document.createElement("span");
            tag.className = "tag";
            const labelSpan = document.createElement("span");
            labelSpan.textContent = label;
            const removeBtn = document.createElement("button");
            removeBtn.type = "button";
            removeBtn.className = "tag-remove";
            removeBtn.innerHTML = "&times;";
            removeBtn.setAttribute("aria-label", `Remove ${label}`);
            removeBtn.addEventListener("click", () => {
              selectedGroupMap.delete(value);
              renderGroups();
            });
            tag.appendChild(labelSpan);
            tag.appendChild(removeBtn);
            groupTags.appendChild(tag);

            const hidden = document.createElement("input");
            hidden.type = "hidden";
            hidden.name = "groups";
            hidden.value = value;
            groupHiddenInputs.appendChild(hidden);
          });
          groupTags.hidden = selectedGroupMap.size === 0;
        };

        const addGroup = (value, label, silent = false) => {
          if (!value || selectedGroupMap.has(value)) {
            return;
          }
          selectedGroupMap.set(value, {
            value,
            label: formatGroupLabel(value, label),
          });
          if (!silent) {
            renderGroups();
          }
        };

        const setGroups = (values) => {
          selectedGroupMap.clear();
          (values || []).forEach((value) => {
            if (!value) {
              return;
            }
            addGroup(value, undefined, true);
          });
          renderGroups();
        };

        setGroups(initialGroups);

        const applyRoleGroups = () => {
          if (!jobRoleInput) {
            return;
          }
          const roleName = jobRoleInput.value.trim();
          if (!roleName) {
            renderGroups();
            return;
          }
          const defaults = roleGroups[roleName] || [];
          let changed = false;
          defaults.forEach((value) => {
            if (!value) {
              return;
            }
            if (!selectedGroupMap.has(value)) {
              addGroup(value, undefined, true);
              changed = true;
            }
          });
          if (changed) {
            renderGroups();
          }
        };

        const originalApplyRoleGroups = applyRoleGroups;
        const applyRoleGroupsWithLicense = (forceLicense = false) => {
          originalApplyRoleGroups();
          if (forceLicense) {
            applyRoleLicenseDefaults(true);
          } else {
            applyRoleLicenseDefaults();
          }
        };

        jobRoleInput?.addEventListener("change", () => applyRoleGroupsWithLicense(false));
        jobRoleInput?.addEventListener("blur", () => applyRoleGroupsWithLicense(false));
        applyRoleGroupsButton?.addEventListener("click", () => {
          applyRoleGroupsWithLicense(true);
          groupSearchInput?.focus();
        });

        let groupSearchTimer;
        const clearGroupResults = () => {
          if (!groupResults) {
            return;
          }
          groupResults.innerHTML = "";
          groupResults.hidden = true;
        };

        groupSearchInput?.addEventListener("input", () => {
          if (!groupSearchInput) {
            return;
          }
          const term = groupSearchInput.value.trim();
          clearTimeout(groupSearchTimer);
          if (!term) {
            clearGroupResults();
            return;
          }
          groupSearchTimer = window.setTimeout(async () => {
            try {
              const payload = await fetchJson("/api/groups", term);
              const items = payload.items || [];
              if (!groupResults) {
                return;
              }
              groupResults.innerHTML = "";
              items.forEach((item) => {
                const dn = item.distinguishedName;
                if (!dn) {
                  return;
                }
                const div = document.createElement("div");
                div.className = "autocomplete-item";
                div.textContent = item.name || formatGroupLabel(dn);
                div.addEventListener("mousedown", (event) => {
                  event.preventDefault();
                  addGroup(dn, item.name || formatGroupLabel(dn));
                  renderGroups();
                  if (groupSearchInput) {
                    groupSearchInput.value = "";
                  }
                  clearGroupResults();
                });
                groupResults.appendChild(div);
              });
              groupResults.hidden = groupResults.children.length === 0;
            } catch (error) {
              console.error(error);
              clearGroupResults();
            }
          }, 200);
        });
        groupSearchInput?.addEventListener("keydown", (event) => {
          if (event.key === "Enter") {
            event.preventDefault();
          }
        });
        groupSearchInput?.addEventListener("blur", () => {
          window.setTimeout(clearGroupResults, 150);
        });

        applyRoleGroupsWithLicense(true);

        const domain = {{ (email_domain or '')|tojson }};
        const emailInput = document.getElementById("email");
        const usernameInput = document.getElementById("username");
        const firstNameInput = document.getElementById("first_name");
        const lastNameInput = document.getElementById("last_name");

        const formatPersonName = (value) =>
          (value || "")
            .toLowerCase()
            .replace(/(^|[\s\-'])([a-z])/g, (match, separator, char) => `${separator}${char.toUpperCase()}`);

        const applyPersonNameFormatting = (input) => {
          if (!input) {
            return;
          }
          const original = input.value;
          const formatted = formatPersonName(original);
          if (formatted !== original) {
            const start = input.selectionStart;
            const end = input.selectionEnd;
            input.value = formatted;
            if (typeof start === "number" && typeof end === "number") {
              input.setSelectionRange(start, end);
            }
          }
        };
        const updateEmail = () => {
          if (!domain || !emailInput || !usernameInput) {
            return;
          }
          const username = usernameInput.value.trim();
          emailInput.value = username ? `${username}@${domain}` : "";
        };

        let usernameManuallyEdited = false;
        if (usernameInput) {
          usernameManuallyEdited = usernameInput.dataset.manual === "1";
          usernameInput.addEventListener("input", () => {
            usernameManuallyEdited = true;
            usernameInput.dataset.manual = "1";
            updateEmail();
          });
        }

        const sanitizeForUsername = (value) => {
          if (!value) {
            return "";
          }
          return value
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .replace(/[^a-z0-9]/gi, "")
            .toLowerCase();
        };

        const formatUsernamePart = (value) => {
          const slug = sanitizeForUsername(value);
          if (!slug) {
            return "";
          }
          return slug.charAt(0).toUpperCase() + slug.slice(1);
        };

        const updateUsernameIfNeeded = () => {
          if (!usernameInput || usernameManuallyEdited) {
            return;
          }
          const first = formatUsernamePart(firstNameInput?.value || "");
          const last = formatUsernamePart(lastNameInput?.value || "");
          const parts = [first, last].filter(Boolean);
          const suggestion =
            parts.length === 0 ? "" : parts.length === 1 ? parts[0] : `${parts[0]}.${parts[1]}`;
          usernameInput.value = suggestion;
          updateEmail();
        };

        firstNameInput?.addEventListener("input", () => {
          applyPersonNameFormatting(firstNameInput);
          updateUsernameIfNeeded();
        });
        lastNameInput?.addEventListener("input", () => {
          applyPersonNameFormatting(lastNameInput);
          updateUsernameIfNeeded();
        });
        firstNameInput?.addEventListener("blur", () => applyPersonNameFormatting(firstNameInput));
        lastNameInput?.addEventListener("blur", () => applyPersonNameFormatting(lastNameInput));

        wireDatalist(
          "job_role",
          "clone-job-role-suggestions",
          "/api/job-titles",
          {{ job_titles|tojson }},
          { minLength: 1, preload: true, limit: 500 }
        );
        wireDatalist(
          "user_ou",
          "clone-ou-suggestions",
          "/api/ous",
          {{ ous|tojson }}
        );
        wireDatalist(
          "company",
          "clone-company-suggestions",
          "/api/companies",
          {{ companies|tojson }}
        );
        wireDatalist(
          "office",
          "clone-office-suggestions",
          "/api/offices",
          {{ offices|tojson }}
        );
        wireManagerAutocomplete();
        applyPersonNameFormatting(firstNameInput);
        applyPersonNameFormatting(lastNameInput);
        updateUsernameIfNeeded();
        if (!emailInput?.value) {
          updateEmail();
        }
      });
    </script>
  {% endif %}
{% endblock %}
