{% extends "base.html" %}
{% block title %}Clone User Â· Onboard &amp; Offboard{% endblock %}
{% block content %}
  <h1>Clone an Existing User</h1>
  <form method="get" class="field" action="{{ url_for('clone_user') }}">
    <label for="query">Search Directory</label>
    <div style="display:flex; gap:0.5rem;">
      <input id="query" name="query" type="text" value="{{ query }}" placeholder="Search by name, username, or email" />
      <button type="submit">Search</button>
    </div>
  </form>

  {% if search_results %}
    <h2>Results</h2>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Username</th>
          <th>Email</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for user in search_results %}
          <tr>
            <td>{{ user.get('displayName') }}</td>
            <td>{{ user.get('sAMAccountName') }}</td>
            <td>{{ user.get('mail') }}</td>
            <td><a class="button secondary" href="{{ url_for('clone_user', user_dn=user.get('distinguishedName')) }}">Use as template</a></td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% elif query %}
    <p>No users matched "{{ query }}".</p>
  {% endif %}

  {% if selected_user %}
    <h2 style="margin-top: 2rem;">Clone Details</h2>
    <form method="post">
      <input type="hidden" name="source_dn" value="{{ selected_user.get('distinguishedName') }}" />
      <div class="field">
        <label for="first_name">New First Name</label>
        <input id="first_name" name="first_name" type="text" value="{{ request.form.first_name or '' }}" required />
      </div>
      <div class="field">
        <label for="last_name">New Last Name</label>
        <input id="last_name" name="last_name" type="text" value="{{ request.form.last_name or '' }}" required />
      </div>
      <div class="field">
        <label for="username">New Username (sAMAccountName)</label>
        <input
          id="username"
          name="username"
          type="text"
          value="{{ request.form.username or generated_username or '' }}"
          data-manual="{{ '1' if request.form.username else '0' }}"
          required
          autocomplete="off"
        />
      </div>
      <div class="field">
        <label for="email">New Email</label>
        <input
          id="email"
          name="email"
          type="email"
          value="{{ request.form.email or generated_email or '' }}"
          required
          {% if email_domain %}readonly{% endif %}
        />
      </div>
      <div class="field">
        <label for="telephone_number">Telephone Number (optional)</label>
        <input
          id="telephone_number"
          name="telephone_number"
          type="tel"
          value="{{ request.form.telephone_number or '' }}"
          placeholder="+16125551234"
          autocomplete="off"
        />
      </div>
      <div class="field">
        <label for="mobile_number">Mobile Number (optional)</label>
        <input
          id="mobile_number"
          name="mobile_number"
          type="tel"
          value="{{ request.form.mobile_number or '' }}"
          placeholder="+16125551234"
          autocomplete="off"
        />
      </div>
      <div class="field">
        <label for="job_role">Target Job Role</label>
        <input
          id="job_role"
          name="job_role"
          type="text"
          list="clone-job-role-suggestions"
          value="{{ request.form.job_role or prefilled_job_role or '' }}"
          placeholder="Start typing a job title"
          required
          autocomplete="off"
        />
        <datalist id="clone-job-role-suggestions">
          {% for name in job_roles.keys() %}
            <option value="{{ name }}"></option>
          {% endfor %}
        </datalist>
        <div class="hint">Pick an existing role or enter a new job title.</div>
      </div>
      <div class="field">
        <label for="group_search">Groups</label>
        <div id="group_tags" class="tag-list"></div>
        <div class="autocomplete">
          <input
            id="group_search"
            type="text"
            placeholder="Search for groups"
            autocomplete="off"
          />
          <div class="autocomplete-results" id="group_results" hidden></div>
        </div>
        <button type="button" class="inline-button" id="apply_role_groups">Apply role groups</button>
        <div class="hint">
          Groups from the template user and selected role are listed here. Search to add more or remove tags to exclude.
        </div>
        <div id="group_hidden_inputs"></div>
      </div>
      <div class="field">
        <label for="password">Temporary Password (optional)</label>
        <input id="password" name="password" type="password" />
      </div>
      <div class="field">
        <label for="manager_dn">Manager</label>
        <div class="autocomplete">
          <input
            id="manager_search"
            name="manager_search"
            type="text"
            value="{{ request.form.manager_search or default_manager_label or '' }}"
            placeholder="Search by name, username, or email"
            autocomplete="off"
          />
          <input
            id="manager_dn"
            name="manager_dn"
            type="hidden"
            value="{{ request.form.manager_dn or default_manager or '' }}"
          />
          <div class="autocomplete-results" id="manager_results" hidden></div>
        </div>
        <button type="button" class="inline-button" id="manager_use_default">Use job role default</button>
        <div class="hint">Leave blank to apply the job role&rsquo;s default manager.</div>
      </div>
      <div class="field">
        <label for="company">Company</label>
        <input
          id="company"
          name="company"
          type="text"
          list="clone-company-suggestions"
          value="{{ request.form.company or selected_user.get('company') or '' }}"
          placeholder="Select or type a company"
          autocomplete="off"
        />
        <datalist id="clone-company-suggestions">
          {% for company in companies %}
            <option value="{{ company }}"></option>
          {% endfor %}
        </datalist>
      </div>
      <div class="field">
        <label for="office">Office (optional)</label>
        <input
          id="office"
          name="office"
          type="text"
          list="clone-office-suggestions"
          value="{{ request.form.office or selected_user.get('physicalDeliveryOfficeName') or '' }}"
          placeholder="Select or type an office"
          autocomplete="off"
        />
        <datalist id="clone-office-suggestions">
          {% for office in offices %}
            <option value="{{ office }}"></option>
          {% endfor %}
        </datalist>
      </div>
      <div class="field">
        <label for="user_ou">Organizational Unit</label>
        <input
          id="user_ou"
          name="user_ou"
          type="text"
          list="clone-ou-suggestions"
          value="{{ request.form.user_ou or default_ou or '' }}"
          placeholder="Leave blank to use the job role default"
          autocomplete="off"
        />
        <datalist id="clone-ou-suggestions">
          {% for ou in ous %}
            <option value="{{ ou }}"></option>
          {% endfor %}
        </datalist>
      </div>
      <div class="field">
        <label for="attributes">Attributes (key=value per line)</label>
        <textarea id="attributes" name="attributes">{{ request.form.attributes or default_attributes }}</textarea>
      </div>
      <div class="field">
        <button type="submit">Clone Account &amp; Sync</button>
      </div>
    </form>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const fetchJson = async (endpoint, query, limit = 20) => {
          const url = new URL(endpoint, window.location.origin);
          if (query) {
            url.searchParams.set("q", query);
          }
          if (limit) {
            url.searchParams.set("limit", limit);
          }
          const response = await fetch(url.toString(), {
            headers: { Accept: "application/json" },
          });
          if (!response.ok) {
            throw new Error(`Directory lookup failed (${response.status})`);
          }
          return response.json();
        };

        const wireDatalist = (inputId, datalistId, endpoint, initial = []) => {
          const input = document.getElementById(inputId);
          const datalist = document.getElementById(datalistId);
          if (!input || !datalist) {
            return;
          }
          const render = (items) => {
            datalist.innerHTML = "";
            items.forEach((item) => {
              if (!item) {
                return;
              }
              const option = document.createElement("option");
              option.value = item;
              datalist.appendChild(option);
            });
          };
          render(initial);
          let timer;
          input.addEventListener("input", () => {
            clearTimeout(timer);
            const value = input.value.trim();
            if (value.length < 2) {
              return;
            }
            timer = setTimeout(async () => {
              try {
                const payload = await fetchJson(endpoint, value);
                render(payload.items || []);
              } catch (error) {
                console.error(error);
              }
            }, 200);
          });
        };

        const wireManagerAutocomplete = () => {
          const input = document.getElementById("manager_search");
          const hidden = document.getElementById("manager_dn");
          const results = document.getElementById("manager_results");
          const useDefaultBtn = document.getElementById("manager_use_default");
          if (!input || !hidden || !results || !useDefaultBtn) {
            return;
          }
          const clearResults = () => {
            results.innerHTML = "";
            results.hidden = true;
          };
          let timer;
          input.addEventListener("input", () => {
            if (!input.dataset.manual) {
              hidden.value = "";
            }
            input.dataset.manual = "1";
            clearTimeout(timer);
            const value = input.value.trim();
            if (value.length < 2) {
              clearResults();
              return;
            }
            timer = setTimeout(async () => {
              try {
                const payload = await fetchJson("/api/managers", value);
                results.innerHTML = "";
                (payload.items || []).forEach((item) => {
                  if (!item || !item.distinguishedName) {
                    return;
                  }
                  const div = document.createElement("div");
                  div.className = "autocomplete-item";
                  const segments = [];
                  if (item.displayName) {
                    segments.push(item.displayName);
                  }
                  if (item.title) {
                    segments.push(`(${item.title})`);
                  }
                  if (item.mail) {
                    segments.push(item.mail);
                  }
                  if (item.sAMAccountName) {
                    segments.push(item.sAMAccountName);
                  }
                  if (item.userPrincipalName && item.userPrincipalName !== item.mail) {
                    segments.push(item.userPrincipalName);
                  }
                  const label = segments.join(" ").trim();
                  div.textContent = label || item.distinguishedName;
                  div.dataset.dn = item.distinguishedName;
                  div.dataset.display = label;
                  div.addEventListener("mousedown", (event) => {
                    event.preventDefault();
                    hidden.value = div.dataset.dn;
                    input.value = div.dataset.display || div.dataset.dn;
                    input.dataset.manual = "0";
                    clearResults();
                  });
                  results.appendChild(div);
                });
                results.hidden = results.children.length === 0;
              } catch (error) {
                console.error(error);
                clearResults();
              }
            }, 200);
          });
          input.addEventListener("blur", () => {
            setTimeout(clearResults, 150);
          });
          useDefaultBtn.addEventListener("click", () => {
            input.value = "";
            hidden.value = "";
            delete input.dataset.manual;
            clearResults();
          });
        };

        const jobRoleInput = document.getElementById("job_role");
        const roleGroups = {{ role_groups|tojson }};
        const initialGroups = {{ selected_groups|tojson }};
        const groupTags = document.getElementById("group_tags");
        const groupSearchInput = document.getElementById("group_search");
        const groupResults = document.getElementById("group_results");
        const groupHiddenInputs = document.getElementById("group_hidden_inputs");
        const applyRoleGroupsButton = document.getElementById("apply_role_groups");

        const formatGroupLabel = (value, friendly) => {
          if (friendly) {
            return friendly;
          }
          if (!value) {
            return "";
          }
          const match = value.match(/CN=([^,]+)/i);
          return match ? match[1] : value;
        };

        const selectedGroupMap = new Map();

        const renderGroups = () => {
          if (!groupTags || !groupHiddenInputs) {
            return;
          }
          groupTags.innerHTML = "";
          groupHiddenInputs.innerHTML = "";
          selectedGroupMap.forEach(({ value, label }) => {
            const tag = document.createElement("span");
            tag.className = "tag";
            const labelSpan = document.createElement("span");
            labelSpan.textContent = label;
            const removeBtn = document.createElement("button");
            removeBtn.type = "button";
            removeBtn.className = "tag-remove";
            removeBtn.innerHTML = "&times;";
            removeBtn.setAttribute("aria-label", `Remove ${label}`);
            removeBtn.addEventListener("click", () => {
              selectedGroupMap.delete(value);
              renderGroups();
            });
            tag.appendChild(labelSpan);
            tag.appendChild(removeBtn);
            groupTags.appendChild(tag);

            const hidden = document.createElement("input");
            hidden.type = "hidden";
            hidden.name = "groups";
            hidden.value = value;
            groupHiddenInputs.appendChild(hidden);
          });
          groupTags.hidden = selectedGroupMap.size === 0;
        };

        const addGroup = (value, label, silent = false) => {
          if (!value || selectedGroupMap.has(value)) {
            return;
          }
          selectedGroupMap.set(value, {
            value,
            label: formatGroupLabel(value, label),
          });
          if (!silent) {
            renderGroups();
          }
        };

        const setGroups = (values) => {
          selectedGroupMap.clear();
          (values || []).forEach((value) => {
            if (!value) {
              return;
            }
            addGroup(value, undefined, true);
          });
          renderGroups();
        };

        setGroups(initialGroups);

        const applyRoleGroups = () => {
          if (!jobRoleInput) {
            return;
          }
          const roleName = jobRoleInput.value.trim();
          if (!roleName) {
            renderGroups();
            return;
          }
          const defaults = roleGroups[roleName] || [];
          let changed = false;
          defaults.forEach((value) => {
            if (!value) {
              return;
            }
            if (!selectedGroupMap.has(value)) {
              addGroup(value, undefined, true);
              changed = true;
            }
          });
          if (changed) {
            renderGroups();
          }
        };

        jobRoleInput?.addEventListener("change", applyRoleGroups);
        jobRoleInput?.addEventListener("blur", applyRoleGroups);
        applyRoleGroupsButton?.addEventListener("click", () => {
          applyRoleGroups();
          groupSearchInput?.focus();
        });

        let groupSearchTimer;
        const clearGroupResults = () => {
          if (!groupResults) {
            return;
          }
          groupResults.innerHTML = "";
          groupResults.hidden = true;
        };

        groupSearchInput?.addEventListener("input", () => {
          if (!groupSearchInput) {
            return;
          }
          const term = groupSearchInput.value.trim();
          clearTimeout(groupSearchTimer);
          if (!term) {
            clearGroupResults();
            return;
          }
          groupSearchTimer = window.setTimeout(async () => {
            try {
              const payload = await fetchJson("/api/groups", term);
              const items = payload.items || [];
              if (!groupResults) {
                return;
              }
              groupResults.innerHTML = "";
              items.forEach((item) => {
                const dn = item.distinguishedName;
                if (!dn) {
                  return;
                }
                const div = document.createElement("div");
                div.className = "autocomplete-item";
                div.textContent = item.name || formatGroupLabel(dn);
                div.addEventListener("mousedown", (event) => {
                  event.preventDefault();
                  addGroup(dn, item.name || formatGroupLabel(dn));
                  renderGroups();
                  if (groupSearchInput) {
                    groupSearchInput.value = "";
                  }
                  clearGroupResults();
                });
                groupResults.appendChild(div);
              });
              groupResults.hidden = groupResults.children.length === 0;
            } catch (error) {
              console.error(error);
              clearGroupResults();
            }
          }, 200);
        });
        groupSearchInput?.addEventListener("keydown", (event) => {
          if (event.key === "Enter") {
            event.preventDefault();
          }
        });
        groupSearchInput?.addEventListener("blur", () => {
          window.setTimeout(clearGroupResults, 150);
        });

        applyRoleGroups();

        const domain = {{ (email_domain or '')|tojson }};
        const emailInput = document.getElementById("email");
        const usernameInput = document.getElementById("username");
        const firstNameInput = document.getElementById("first_name");
        const lastNameInput = document.getElementById("last_name");

        const formatPersonName = (value) =>
          (value || "")
            .toLowerCase()
            .replace(/(^|[\s\-'])([a-z])/g, (match, separator, char) => `${separator}${char.toUpperCase()}`);

        const applyPersonNameFormatting = (input) => {
          if (!input) {
            return;
          }
          const original = input.value;
          const formatted = formatPersonName(original);
          if (formatted !== original) {
            const start = input.selectionStart;
            const end = input.selectionEnd;
            input.value = formatted;
            if (typeof start === "number" && typeof end === "number") {
              input.setSelectionRange(start, end);
            }
          }
        };
        const updateEmail = () => {
          if (!domain || !emailInput || !usernameInput) {
            return;
          }
          const username = usernameInput.value.trim();
          emailInput.value = username ? `${username}@${domain}` : "";
        };

        let usernameManuallyEdited = false;
        if (usernameInput) {
          usernameManuallyEdited = usernameInput.dataset.manual === "1";
          usernameInput.addEventListener("input", () => {
            usernameManuallyEdited = true;
            usernameInput.dataset.manual = "1";
            updateEmail();
          });
        }

        const sanitizeForUsername = (value) => {
          if (!value) {
            return "";
          }
          return value
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .replace(/[^a-z0-9]/gi, "")
            .toLowerCase();
        };

        const formatUsernamePart = (value) => {
          const slug = sanitizeForUsername(value);
          if (!slug) {
            return "";
          }
          return slug.charAt(0).toUpperCase() + slug.slice(1);
        };

        const updateUsernameIfNeeded = () => {
          if (!usernameInput || usernameManuallyEdited) {
            return;
          }
          const first = formatUsernamePart(firstNameInput?.value || "");
          const last = formatUsernamePart(lastNameInput?.value || "");
          const parts = [first, last].filter(Boolean);
          const suggestion =
            parts.length === 0 ? "" : parts.length === 1 ? parts[0] : `${parts[0]}.${parts[1]}`;
          usernameInput.value = suggestion;
          updateEmail();
        };

        firstNameInput?.addEventListener("input", () => {
          applyPersonNameFormatting(firstNameInput);
          updateUsernameIfNeeded();
        });
        lastNameInput?.addEventListener("input", () => {
          applyPersonNameFormatting(lastNameInput);
          updateUsernameIfNeeded();
        });
        firstNameInput?.addEventListener("blur", () => applyPersonNameFormatting(firstNameInput));
        lastNameInput?.addEventListener("blur", () => applyPersonNameFormatting(lastNameInput));

        wireDatalist(
          "job_role",
          "clone-job-role-suggestions",
          "/api/job-titles",
          {{ job_roles.keys()|list|tojson }}
        );
        wireDatalist(
          "user_ou",
          "clone-ou-suggestions",
          "/api/ous",
          {{ ous|tojson }}
        );
        wireDatalist(
          "company",
          "clone-company-suggestions",
          "/api/companies",
          {{ companies|tojson }}
        );
        wireDatalist(
          "office",
          "clone-office-suggestions",
          "/api/offices",
          {{ offices|tojson }}
        );
        wireManagerAutocomplete();
        applyPersonNameFormatting(firstNameInput);
        applyPersonNameFormatting(lastNameInput);
        updateUsernameIfNeeded();
        if (!emailInput?.value) {
          updateEmail();
        }
      });
    </script>
  {% endif %}
{% endblock %}
