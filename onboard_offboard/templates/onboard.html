{% extends "base.html" %}
{% block title %}Onboard Employee Â· Onboard &amp; Offboard{% endblock %}
{% block content %}
  <h1>Onboard a New Employee</h1>
  <form method="post">
    <div class="field">
      <label for="first_name">First Name</label>
      <input id="first_name" name="first_name" type="text" value="{{ request.form.first_name or '' }}" required />
    </div>
    <div class="field">
      <label for="last_name">Last Name</label>
      <input id="last_name" name="last_name" type="text" value="{{ request.form.last_name or '' }}" required />
    </div>
    <div class="field">
      <label for="username">Username (sAMAccountName)</label>
      <input
        id="username"
        name="username"
        type="text"
        value="{{ request.form.username or generated_username or '' }}"
        data-manual="{{ '1' if request.form.username else '0' }}"
        required
        autocomplete="off"
      />
    </div>
    <div class="field">
      <label for="email">Email</label>
      <input
        id="email"
        name="email"
        type="email"
        value="{{ request.form.email or (request.form.username and email_domain and (request.form.username ~ '@' ~ email_domain)) or generated_email or '' }}"
        required
        {% if email_domain %}readonly{% endif %}
      />
    </div>
    <div class="field">
      <label for="telephone_number">Telephone Number (optional)</label>
      <input
        id="telephone_number"
        name="telephone_number"
        type="tel"
        value="{{ request.form.telephone_number or '' }}"
        placeholder="+16125551234"
        autocomplete="off"
      />
    </div>
    <div class="field">
      <label for="mobile_number">Mobile Number (optional)</label>
      <input
        id="mobile_number"
        name="mobile_number"
        type="tel"
        value="{{ request.form.mobile_number or '' }}"
        placeholder="+16125551234"
        autocomplete="off"
      />
    </div>
    <div class="field">
      <label for="job_role">Job Role</label>
      <input
        id="job_role"
        name="job_role"
        type="text"
        list="job-role-suggestions"
        value="{{ request.form.job_role or '' }}"
        placeholder="Start typing a job title"
        required
        autocomplete="off"
      />
      <datalist id="job-role-suggestions">
        {% for name in job_roles.keys() %}
          <option value="{{ name }}"></option>
        {% endfor %}
      </datalist>
      <div class="hint">Pick an existing role or enter a new job title.</div>
    </div>
    <div class="field">
      <label for="password">Temporary Password (optional)</label>
      <input id="password" name="password" type="password" />
    </div>
    <div class="field">
      <label for="manager_search">Manager</label>
      <div class="autocomplete">
        <input
          id="manager_search"
          name="manager_search"
          type="text"
          value="{{ request.form.manager_search or request.form.manager_dn or '' }}"
          placeholder="Search by name, username, or email"
          autocomplete="off"
        />
        <input id="manager_dn" name="manager_dn" type="hidden" value="{{ request.form.manager_dn or '' }}" />
        <div class="autocomplete-results" id="manager_results" hidden></div>
      </div>
      <button type="button" class="inline-button" id="manager_use_default">Use job role default</button>
      <div class="hint">Leave blank to apply the job role&rsquo;s default manager.</div>
    </div>
    <div class="field">
      <label for="company">Company</label>
      <input
        id="company"
        name="company"
        type="text"
        list="company-suggestions"
        value="{{ request.form.company or '' }}"
        placeholder="Select or type a company"
        autocomplete="off"
      />
      <datalist id="company-suggestions">
        {% for company in companies %}
          <option value="{{ company }}"></option>
        {% endfor %}
      </datalist>
    </div>
    <div class="field">
      <label for="office">Office (optional)</label>
      <input
        id="office"
        name="office"
        type="text"
        list="office-suggestions"
        value="{{ request.form.office or '' }}"
        placeholder="Select or type an office"
        autocomplete="off"
      />
      <datalist id="office-suggestions">
        {% for office in offices %}
          <option value="{{ office }}"></option>
        {% endfor %}
      </datalist>
    </div>
    <div class="field">
      <label for="user_ou">Organizational Unit</label>
      <input
        id="user_ou"
        name="user_ou"
        type="text"
        list="ou-suggestions"
        value="{{ request.form.user_ou or '' }}"
        placeholder="Leave blank to use the job role default"
        autocomplete="off"
      />
      <datalist id="ou-suggestions">
        {% for ou in ous %}
          <option value="{{ ou }}"></option>
        {% endfor %}
      </datalist>
    </div>
    <div class="field">
      <label for="attributes">Additional Attributes (key=value per line)</label>
      <textarea id="attributes" name="attributes">{{ request.form.attributes or '' }}</textarea>
    </div>
    <div class="field">
      <button type="submit">Create Account &amp; Sync</button>
    </div>
  </form>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const fetchJson = async (endpoint, query, limit = 20) => {
        const url = new URL(endpoint, window.location.origin);
        if (query) {
          url.searchParams.set("q", query);
        }
        if (limit) {
          url.searchParams.set("limit", limit);
        }
        const response = await fetch(url.toString(), {
          headers: { Accept: "application/json" },
        });
        if (!response.ok) {
          throw new Error(`Directory lookup failed (${response.status})`);
        }
        return response.json();
      };

      const wireDatalist = (inputId, datalistId, endpoint, initial = []) => {
        const input = document.getElementById(inputId);
        const datalist = document.getElementById(datalistId);
        if (!input || !datalist) {
          return;
        }
        const render = (items) => {
          datalist.innerHTML = "";
          items.forEach((item) => {
            if (!item) {
              return;
            }
            const option = document.createElement("option");
            option.value = item;
            datalist.appendChild(option);
          });
        };
        render(initial);
        let timer;
        input.addEventListener("input", () => {
          clearTimeout(timer);
          const value = input.value.trim();
          if (value.length < 2) {
            return;
          }
          timer = setTimeout(async () => {
            try {
              const payload = await fetchJson(endpoint, value);
              render(payload.items || []);
            } catch (error) {
              console.error(error);
            }
          }, 200);
        });
      };

      const wireManagerAutocomplete = () => {
        const input = document.getElementById("manager_search");
        const hidden = document.getElementById("manager_dn");
        const results = document.getElementById("manager_results");
        const useDefaultBtn = document.getElementById("manager_use_default");
        if (!input || !hidden || !results || !useDefaultBtn) {
          return;
        }
        const clearResults = () => {
          results.innerHTML = "";
          results.hidden = true;
        };
        let timer;
        input.addEventListener("input", () => {
          if (!input.dataset.manual) {
            hidden.value = "";
          }
          input.dataset.manual = "1";
          clearTimeout(timer);
          const value = input.value.trim();
          if (value.length < 2) {
            clearResults();
            return;
          }
          timer = setTimeout(async () => {
            try {
              const payload = await fetchJson("/api/managers", value);
              results.innerHTML = "";
              (payload.items || []).forEach((item) => {
                if (!item || !item.distinguishedName) {
                  return;
                }
                const div = document.createElement("div");
                div.className = "autocomplete-item";
                const segments = [];
                if (item.displayName) {
                  segments.push(item.displayName);
                }
                if (item.title) {
                  segments.push(`(${item.title})`);
                }
                if (item.mail) {
                  segments.push(item.mail);
                }
                if (item.sAMAccountName) {
                  segments.push(item.sAMAccountName);
                }
                if (item.userPrincipalName && item.userPrincipalName !== item.mail) {
                  segments.push(item.userPrincipalName);
                }
                const label = segments.join(" ").trim();
                div.textContent = label || item.distinguishedName;
                div.dataset.dn = item.distinguishedName;
                div.dataset.display = label;
                div.addEventListener("mousedown", (event) => {
                  event.preventDefault();
                  hidden.value = div.dataset.dn;
                  input.value = div.dataset.display || div.dataset.dn;
                  input.dataset.manual = "0";
                  clearResults();
                });
                results.appendChild(div);
              });
              results.hidden = results.children.length === 0;
            } catch (error) {
              console.error(error);
              clearResults();
            }
          }, 200);
        });
        input.addEventListener("blur", () => {
          setTimeout(clearResults, 150);
        });
        useDefaultBtn.addEventListener("click", () => {
          input.value = "";
          hidden.value = "";
          delete input.dataset.manual;
          clearResults();
        });
      };

      const domain = {{ (email_domain or '')|tojson }};
      const emailInput = document.getElementById("email");
      const usernameInput = document.getElementById("username");
      const firstNameInput = document.getElementById("first_name");
      const lastNameInput = document.getElementById("last_name");

      const formatPersonName = (value) =>
        (value || "")
          .toLowerCase()
          .replace(/(^|[\s\-'])([a-z])/g, (match, separator, char) => `${separator}${char.toUpperCase()}`);

      const applyPersonNameFormatting = (input) => {
        if (!input) {
          return;
        }
        const original = input.value;
        const formatted = formatPersonName(original);
        if (formatted !== original) {
          const start = input.selectionStart;
          const end = input.selectionEnd;
          input.value = formatted;
          if (typeof start === "number" && typeof end === "number") {
            input.setSelectionRange(start, end);
          }
        }
      };

      const updateEmail = () => {
        if (!domain || !emailInput || !usernameInput) {
          return;
        }
        const username = usernameInput.value.trim();
        emailInput.value = username ? `${username}@${domain}` : "";
      };

      let usernameManuallyEdited = false;
      if (usernameInput) {
        usernameManuallyEdited = usernameInput.dataset.manual === "1";
        usernameInput.addEventListener("input", () => {
          usernameManuallyEdited = true;
          usernameInput.dataset.manual = "1";
          updateEmail();
        });
      }

      const sanitizeForUsername = (value) => {
        if (!value) {
          return "";
        }
        return value
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .replace(/[^a-z0-9]/gi, "")
          .toLowerCase();
      };

      const formatUsernamePart = (value) => {
        const slug = sanitizeForUsername(value);
        if (!slug) {
          return "";
        }
        return slug.charAt(0).toUpperCase() + slug.slice(1);
      };

      const updateUsernameIfNeeded = () => {
        if (!usernameInput || usernameManuallyEdited) {
          return;
        }
        const first = formatUsernamePart(firstNameInput?.value || "");
        const last = formatUsernamePart(lastNameInput?.value || "");
        const parts = [first, last].filter(Boolean);
        const suggestion =
          parts.length === 0 ? "" : parts.length === 1 ? parts[0] : `${parts[0]}.${parts[1]}`;
        usernameInput.value = suggestion;
        updateEmail();
      };

      firstNameInput?.addEventListener("input", () => {
        applyPersonNameFormatting(firstNameInput);
        updateUsernameIfNeeded();
      });
      lastNameInput?.addEventListener("input", () => {
        applyPersonNameFormatting(lastNameInput);
        updateUsernameIfNeeded();
      });
      firstNameInput?.addEventListener("blur", () => applyPersonNameFormatting(firstNameInput));
      lastNameInput?.addEventListener("blur", () => applyPersonNameFormatting(lastNameInput));

      wireDatalist(
        "job_role",
        "job-role-suggestions",
        "/api/job-titles",
        {{ job_roles.keys()|list|tojson }}
      );
      wireDatalist(
        "user_ou",
        "ou-suggestions",
        "/api/ous",
        {{ ous|tojson }}
      );
      wireDatalist(
        "company",
        "company-suggestions",
        "/api/companies",
        {{ companies|tojson }}
      );
      wireDatalist(
        "office",
        "office-suggestions",
        "/api/offices",
        {{ offices|tojson }}
      );
      wireManagerAutocomplete();
      applyPersonNameFormatting(firstNameInput);
      applyPersonNameFormatting(lastNameInput);
      updateUsernameIfNeeded();
      if (!emailInput?.value) {
        updateEmail();
      }
    });
  </script>
{% endblock %}
